stages:
  - hugo-build

update-website:
  stage: hugo-build
  only:
    - master
  allow_failure: false
  image: "alpine:3.9.3"
  script:
  # $GIT_SSH_PRIV_KEY: base64 encoded one-liner
    - 'which ssh-agent || (apk update && apk --no-cache add openssh-client git)'
    - eval $(ssh-agent -s)
    - echo $GIT_SSH_PRIV_KEY > tmp.secret
    - base64 -d tmp.secret > tmp.key
    - chmod 400 tmp.key
    - ssh-add tmp.key
    - rm -f tmp.key tmp.secret
    - mkdir -p ~/.ssh
    - ssh-keyscan gitlab.com >> gitlab-known-hosts
    - cat gitlab-known-hosts >> ~/.ssh/known_hosts
    - 'git config --global user.email "$GIT_EMAIL"'
    - 'git config --global user.name "$GIT_USER"'
    - rm -rf public
    - mkdir hugo && cd hugo
    - wget -O  hugo.tar.gz $HUGO_LINK
    - tar -xzf hugo.tar.gz
    - mv hugo /bin
    - rm -rf hugo
    - hugo
    - mv public ../
    - git remote set-url origin git@gitlab.com:schlauerlauer/website.git
    - git checkout public
    - rm -rf public
    - mv ../public .
    - git add -A
    - git commit -m "$GIT_USER $(date +%d.%m.%y)"
    - git push